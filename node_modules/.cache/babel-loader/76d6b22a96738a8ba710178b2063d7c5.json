{"ast":null,"code":"import { SERIALIZE } from './rehydrate';\nexport class Devtools {\n  constructor(name) {\n    this.safeClassNames = new Set();\n    this.unsafeClassNames = new Set();\n    this.buffer = [];\n    this.isConnected = false;\n    this.doReconnect = false;\n    this.hasWarnedReconnect = false;\n    this.reconnectInterval = 10000;\n\n    this.connect = (host, onMessage) => {\n      host = host || 'localhost:3031';\n      this.ws = new WebSocket(`ws://${host}?name=${this.name}`);\n\n      this.ws.onmessage = event => onMessage(JSON.parse(event.data));\n\n      this.ws.onopen = () => {\n        this.isConnected = true;\n        this.sendBuffer();\n      };\n\n      this.ws.onerror = () => {\n        console.error(`OVERMIND DEVTOOLS: Not able to connect. You are trying to connect to \"${host}\", but there was no devtool there. Try the following:\n        \n          - Make sure you are running the latest version of the devtools, using \"npx overmind-devtools@latest\" or install latest extension for VSCode\n          - Close the current tab and open a new one\n          - Make sure the correct port is configured in the devtools\n        `);\n      };\n\n      this.ws.onclose = () => {\n        this.isConnected = false;\n\n        if (this.doReconnect && !this.hasWarnedReconnect) {\n          console.warn('Debugger application is not running on selected port... will reconnect automatically behind the scenes');\n          this.hasWarnedReconnect = true;\n        }\n\n        if (this.doReconnect) {\n          this.reconnect(host, onMessage);\n        }\n      };\n    };\n\n    this.sendBuffer = () => {\n      if (this.isConnected && this.buffer.length) {\n        this.ws.send(`{ \"appName\": \"${this.name}\", \"message\": ${this.buffer.shift()} }`);\n\n        if (this.buffer.length) {\n          setTimeout(this.sendBuffer);\n        }\n      }\n    };\n\n    this.name = name;\n  }\n\n  reconnect(host, onMessage) {\n    setTimeout(() => this.connect(host, onMessage), this.reconnectInterval);\n  }\n\n  send(message) {\n    const safeClassNames = this.safeClassNames;\n    const unsafeClassNames = this.unsafeClassNames;\n    const stringifiedMessage = JSON.stringify(message, function (_, value) {\n      if (typeof value === 'function') {\n        return '[Function]';\n      }\n\n      if (this.__CLASS__) {\n        return value;\n      }\n\n      if (value && value[SERIALIZE]) {\n        return {\n          __CLASS__: true,\n          name: value.constructor.name,\n          value\n        };\n      }\n\n      if (typeof value === 'object' && value !== null && !Array.isArray(value) && value.constructor && value.constructor.name !== 'Object') {\n        if (!safeClassNames.has(value.constructor.name) && !unsafeClassNames.has(value.constructor.name)) {\n          try {\n            JSON.stringify(value);\n            safeClassNames.add(value.constructor.name);\n          } catch (_a) {\n            unsafeClassNames.add(value.constructor.name);\n          }\n        }\n\n        if (safeClassNames.has(value.constructor.name)) {\n          return {\n            __CLASS__: true,\n            name: value.constructor.name,\n            value\n          };\n        } else {\n          return `[${value.constructor.name || 'NOT SERIALIZABLE'}]`;\n        }\n      }\n\n      return value;\n    }, 0);\n    this.buffer.push(stringifiedMessage);\n    this.sendBuffer();\n  }\n\n}","map":{"version":3,"sources":["../src/Devtools.ts"],"names":[],"mappings":"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","sourcesContent":["import { SERIALIZE } from './rehydrate'\n\nexport type Message = {\n  type: string\n  data?: object\n}\n\nexport type DevtoolsMessage = {\n  type: string\n  appName: string\n  data: any\n}\n\nexport class Devtools {\n  private safeClassNames: Set<string> = new Set()\n  private unsafeClassNames: Set<string> = new Set()\n  private buffer: string[] = []\n  private ws: WebSocket\n  private isConnected: boolean = false\n  private doReconnect: boolean = false\n  private hasWarnedReconnect: boolean = false\n  private reconnectInterval: number = 10000\n  private name: string\n  constructor(name: string) {\n    this.name = name\n  }\n  connect = (host: string, onMessage: (message: Message) => void) => {\n    host = host || 'localhost:3031'\n\n    this.ws = new WebSocket(`ws://${host}?name=${this.name}`)\n    this.ws.onmessage = (event) => onMessage(JSON.parse(event.data))\n    this.ws.onopen = () => {\n      this.isConnected = true\n      this.sendBuffer()\n    }\n    this.ws.onerror = () => {\n      console.error(\n        `OVERMIND DEVTOOLS: Not able to connect. You are trying to connect to \"${host}\", but there was no devtool there. Try the following:\n        \n          - Make sure you are running the latest version of the devtools, using \"npx overmind-devtools@latest\" or install latest extension for VSCode\n          - Close the current tab and open a new one\n          - Make sure the correct port is configured in the devtools\n        `\n      )\n    }\n    this.ws.onclose = () => {\n      this.isConnected = false\n\n      if (this.doReconnect && !this.hasWarnedReconnect) {\n        console.warn(\n          'Debugger application is not running on selected port... will reconnect automatically behind the scenes'\n        )\n        this.hasWarnedReconnect = true\n      }\n\n      if (this.doReconnect) {\n        this.reconnect(host, onMessage)\n      }\n    }\n  }\n  private reconnect(host, onMessage) {\n    setTimeout(\n      () =>\n        this.connect(\n          host,\n          onMessage\n        ),\n      this.reconnectInterval\n    )\n  }\n  send(message: Message) {\n    const safeClassNames = this.safeClassNames\n    const unsafeClassNames = this.unsafeClassNames\n    const stringifiedMessage = JSON.stringify(\n      message,\n      function (_, value) {\n        if (typeof value === 'function') {\n          return '[Function]'\n        }\n\n        if (this.__CLASS__) {\n          return value\n        }\n\n        if (value && value[SERIALIZE]) {\n          return {\n            __CLASS__: true,\n            name: value.constructor.name,\n            value   \n          }\n        }\n\n        if (\n          typeof value === 'object' &&\n          value !== null &&\n          !Array.isArray(value) &&\n          value.constructor &&\n          value.constructor.name !== 'Object'\n        ) {\n          if (!safeClassNames.has(value.constructor.name) && !unsafeClassNames.has(value.constructor.name)) {\n            try {\n              JSON.stringify(value)\n              safeClassNames.add(value.constructor.name)\n            } catch {\n              unsafeClassNames.add(value.constructor.name)\n            }\n          }\n          \n          if (safeClassNames.has(value.constructor.name)) {\n            return {\n              __CLASS__: true,\n              name: value.constructor.name,\n              value\n            }\n          } else {\n            return `[${value.constructor.name || 'NOT SERIALIZABLE'}]`\n          }\n        }\n\n        return value\n      },\n      0\n    )\n    this.buffer.push(stringifiedMessage)\n    this.sendBuffer()\n  }\n  private sendBuffer = () => {\n    if (this.isConnected && this.buffer.length) {\n      this.ws.send(\n        `{ \"appName\": \"${this.name}\", \"message\": ${this.buffer.shift()} }`\n      )\n\n      if (this.buffer.length) {\n        setTimeout(this.sendBuffer)\n      }\n    }\n  }\n}\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}